node {
  name = "emqx@127.0.0.1"
  cookie = "emqxsecretcookie"
  data_dir = "/opt/emqx/data"
}

listeners.tcp.default {
  bind = "0.0.0.0:1883"
}

listeners.ws.default {
  bind = "0.0.0.0:8083"
  max_connections = 10000
  websocket.mqtt_path = "/mqtt"
}

listeners.wss.default {
  bind = "0.0.0.0:8084"
  max_connections = 10000
  websocket.mqtt_path = "/mqtt"
  ssl_options {
    cacertfile = "/opt/emqx/etc/certs/cacert.pem"
    certfile = "/opt/emqx/etc/certs/cert.pem"
    keyfile = "/opt/emqx/etc/certs/key.pem"
    verify = verify_none
  }
}

dashboard {
  listeners.http {
    bind = "0.0.0.0:18083"
  }
  default_username = "${EMQX_DASHBOARD_USER}"
  default_password = "${EMQX_DASHBOARD_PASSWORD}"
}

# ============================================================================
# AUTHENTICATION (Multi-Tenant Production)
# ============================================================================

authentication = [
  {
    mechanism = password_based
    backend = postgresql
    server = "postgres:5432"
    database = "iiot_platform"
    username = "admin"
    password = "0039"
    pool_size = 8
    
    password_hash_algorithm {
      name = bcrypt
    }
    
    # Uses emqx_auth_v2 view (multi-tenant)
    query = "SELECT password_hash, password_hash_algorithm FROM emqx_auth_v2 WHERE username = ${username} LIMIT 1"
  }
]

# ============================================================================
# AUTHORIZATION (Multi-Tenant ACLs)
# ============================================================================

authorization {
  no_match = deny
  sources = [
    {
      type = postgresql
      enable = true
      server = "postgres:5432"
      database = "iiot_platform"
      username = "admin"
      password = "0039"
      pool_size = 8
      
      # Uses emqx_acl_v2 view (tenant-scoped topics)
      query = "SELECT permission, action, topic FROM emqx_acl_v2 WHERE username = ${username}"
    }
  ]
}

