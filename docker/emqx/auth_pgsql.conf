# EMQX PostgreSQL Authentication
# Devices authenticate using token as password

authentication {
  backend = postgresql
  mechanism = password_based
  
  server = "iiot_postgres:5432"
  database = "iiot_platform"
  username = "admin"
  password = "0039"
  
  password_hash_algorithm {
    name = plain
  }
  
  # Query validates token sent as password
  # ${password} = token sent by device
  # Returns same token as password_hash for validation
  query = "SELECT ${password}::uuid as password_hash FROM devices WHERE token = ${password}::uuid AND status = 'active'"
}